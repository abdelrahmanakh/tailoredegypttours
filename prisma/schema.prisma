// npx prisma db push
// npx prisma generate
// 1. GLOBAL SETTINGS
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// 2. ENUMS
enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum RecurrenceType {
  WEEKLY
  MONTHLY
  SPECIFIC_DATES
}

// 3. CORE MODELS

model Language {
  id        String  @id @default(uuid())
  code      String  @unique 
  name      String  
  isDefault Boolean @default(false)
  isActive  Boolean @default(true)

  tourTranslations         TourTranslation[]
  destinationTranslations  DestinationTranslation[]
  categoryTranslations     CategoryTranslation[]
  itineraryTranslations    TourItineraryTranslation[]
  extraTranslations        TourExtraTranslation[]
  tagTranslations          TagTranslation[]
  FAQTranslations          TourFaqTranslation[]
  tourAudioGuides          TourAudioGuide[]
  altTextTranslations     TourImageTranslation[]
}
model Tag {
  id    String @id @default(uuid())
  slug  String @unique // e.g., 'honeymoon', 'luxury', 'adventure'
  
  isFeatured    Boolean  @default(false)
  featuredOrder Int?
  isActive      Boolean @default(false)

  translations TagTranslation[]
  tours        Tour[]          // Implicit Many-to-Many relation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TagTranslation {
  id         String @id @default(uuid())
  tagId      String
  languageId String
  name       String? // e.g., 'Honeymoon', 'Lune de miel'
  description   String? @db.Text

  tag      Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  language Language @relation(fields: [languageId], references: [id])

  @@unique([tagId, languageId])
}

model TourFaq {
  id       String @id @default(uuid())
  tourId   String
  order    Int

  translations TourFaqTranslation[]

  tour Tour @relation(fields: [tourId], references: [id], onDelete: Cascade)
}

model TourFaqTranslation {
  id         String @id @default(uuid())
  faqId      String
  languageId String

  question   String?
  answer     String? @db.Text

  faq      TourFaq  @relation(fields: [faqId], references: [id], onDelete: Cascade)
  language Language @relation(fields: [languageId], references: [id])

  @@unique([faqId, languageId])
}

model TourAudioGuide {
  id         String   @id @default(uuid())
  tourId     String
  languageId String

  isIncluded Boolean  @default(true)
  extraPrice Int?

  tour     Tour     @relation(fields: [tourId], references: [id], onDelete: Cascade)
  language Language @relation(fields: [languageId], references: [id])

  @@unique([tourId, languageId])
}

model TourLocation {
  id        String  @id @default(uuid())
  tourId    String

  name      String? // e.g. "Tahrir Square Entrance"
  address   String?
  lat       Decimal @db.Decimal(9,6)
  lng       Decimal @db.Decimal(9,6)

  tour      Tour    @relation(fields: [tourId], references: [id], onDelete: Cascade)

  @@unique([tourId])
}

model Tour {
  id           String   @id @default(uuid())
  slug         String   @unique
  durationDays Int
  
  // Pricing 
  priceAdult   Int      
  priceChild   Int      

  // Logistics
  maxCapacity   Int?    
  
  rating        Float   @default(0)
  reviewCount   Int     @default(0)
  isFeatured    Boolean  @default(false)
  featuredOrder Int?
  isActive      Boolean @default(false)
  
  destinationId String
  destination   Destination @relation(fields: [destinationId], references: [id])
  categoryId    String
  category      Category    @relation(fields: [categoryId], references: [id])

  location      TourLocation?
  translations  TourTranslation[]
  images        TourImage[]
  itinerary     TourItinerary[]
  extras        TourExtra[]
  reviews       Review[]
  bookings      Booking[]
  tags          Tag[]
  FAQs          TourFaq[]
  audioGuides TourAudioGuide[]

  // Availability & Capacity Logic
  schedules      TourSchedule[]   
  exceptions     TourException[] 
  dateCapacities TourDateCapacity[] // <--- ADDED

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// 4. AVAILABILITY SYSTEM

// Rule: "We run every Saturday"
model TourSchedule {
  id          String         @id @default(uuid())
  tourId      String
  isActive    Boolean        @default(true)
  
  validFrom   DateTime
  validTo     DateTime?      

  type        RecurrenceType 
  daysOfWeek  Int[]          
  dayOfMonth  Int?           

  tour        Tour           @relation(fields: [tourId], references: [id], onDelete: Cascade)

  // Optimization for fetching active schedules for a tour
  @@index([tourId, isActive]) 
}

// Override: "Closed this specific Saturday"
model TourException {
  id        String   @id @default(uuid())
  tourId    String
  date      DateTime
  
  isBlocked Boolean  
  reason    String?

  tour      Tour     @relation(fields: [tourId], references: [id], onDelete: Cascade)

  // This Unique constraint also acts as an Index for [tourId, date]
  @@unique([tourId, date]) 
}

// Override: "We have extra spots on Dec 25th"
model TourDateCapacity {
  id        String   @id @default(uuid())
  tourId    String
  date      DateTime
  capacity  Int      // The specific capacity for this day

  tour      Tour     @relation(fields: [tourId], references: [id], onDelete: Cascade)

  // Unique constraint ensures only one override per date per tour
  @@unique([tourId, date])
}

// 5. TRANSLATIONS & MEDIA

model TourTranslation {
  id          String @id @default(uuid())
  tourId      String
  languageId  String
  title       String?
  Overview    String?  @db.Text
  description String?  @db.Text
  highlights  String? @db.Text
  included    String? @db.Text
  excluded    String? @db.Text

  tour     Tour     @relation(fields: [tourId], references: [id], onDelete: Cascade)
  language Language @relation(fields: [languageId], references: [id])

  @@unique([tourId, languageId])
}

model TourImage {
  id        String  @id @default(uuid())
  tourId    String
  url       String
  isPrimary Boolean @default(false)
  order     Int     @default(0)

  createdAt DateTime @default(now())
  translations TourImageTranslation[]
  tour      Tour    @relation(fields: [tourId], references: [id], onDelete: Cascade)
}

model TourImageTranslation {
  id        String @id @default(uuid())
  imageId   String
  languageId String

  altText   String?

  image    TourImage @relation(fields: [imageId], references: [id], onDelete: Cascade)
  language Language  @relation(fields: [languageId], references: [id])

  @@unique([imageId, languageId])
}
// 6. CATEGORIZATION

model Destination {
  id        String   @id @default(uuid())
  slug      String   @unique
  imageUrl  String?
  
  isFeatured    Boolean  @default(false)
  featuredOrder Int?
  isActive      Boolean @default(false)

  translations DestinationTranslation[]
  tours        Tour[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model DestinationTranslation {
  id            String @id @default(uuid())
  destinationId String
  languageId    String
  name          String?
  description   String? @db.Text

  destination Destination @relation(fields: [destinationId], references: [id], onDelete: Cascade)
  language    Language    @relation(fields: [languageId], references: [id])

  @@unique([destinationId, languageId])
}

model Category {
  id    String @id @default(uuid())
  slug  String @unique

  isFeatured    Boolean  @default(false)
  featuredOrder Int?
  isActive      Boolean @default(false)

  translations CategoryTranslation[]
  tours        Tour[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CategoryTranslation {
  id         String @id @default(uuid())
  categoryId String
  languageId String
  name       String?
  description   String? @db.Text

  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  language Language @relation(fields: [languageId], references: [id])

  @@unique([categoryId, languageId])
}

// 7. ITINERARY & EXTRAS

model TourItinerary {
  id     String @id @default(uuid())
  day    Int
  tourId String

  translations TourItineraryTranslation[]
  tour         Tour @relation(fields: [tourId], references: [id], onDelete: Cascade)
}

model TourItineraryTranslation {
  id          String @id @default(uuid())
  itineraryId String
  languageId  String
  title       String?
  content     String? @db.Text

  itinerary TourItinerary @relation(fields: [itineraryId], references: [id], onDelete: Cascade)
  language  Language      @relation(fields: [languageId], references: [id])

  @@unique([itineraryId, languageId])
}

model TourExtra {
  id     String @id @default(uuid())
  price  Int    
  tourId String

  translations TourExtraTranslation[]
  bookings     BookingExtra[]
  tour         Tour @relation(fields: [tourId], references: [id], onDelete: Cascade)
}

model TourExtraTranslation {
  id         String @id @default(uuid())
  extraId    String
  languageId String
  name       String

  extra    TourExtra @relation(fields: [extraId], references: [id], onDelete: Cascade)
  language Language  @relation(fields: [languageId], references: [id])

  @@unique([extraId, languageId])
}

// 8. GUEST & BOOKING SYSTEM

model GuestInfo {
  id        String   @id @default(uuid())
  email     String   
  firstName String
  lastName  String
  phone     String?
  createdAt DateTime @default(now())

  bookings  Booking[]
}

model Booking {
  id         String        @id @default(uuid())
  tourId     String
  guestId    String
  
  bookingRef String        @unique 
  travelDate DateTime
  
  adults     Int
  children   Int

  subtotal   Int
  serviceFee Int
  tax        Int
  totalPrice Int
  currency   String        @default("USD")

  status     BookingStatus @default(PENDING)
  createdAt  DateTime      @default(now())

  tour       Tour          @relation(fields: [tourId], references: [id])
  guest      GuestInfo     @relation(fields: [guestId], references: [id])
  extras     BookingExtra[]

  review     Review?

}

model BookingExtra {
  id        String @id @default(uuid())
  bookingId String
  extraId   String
  
  quantity  Int    @default(1)
  pricePaid Int    

  booking   Booking   @relation(fields: [bookingId], references: [id])
  extra     TourExtra @relation(fields: [extraId], references: [id])
}

// 9. REVIEWS

model Review {
  id        String   @id @default(uuid())
  tourId    String
  bookingId String?  @unique 
  
  name      String
  avatar    String?
  location  String?
  
  rating    Int
  comment   String   @db.Text
  date      DateTime @default(now())
  
  isVisible Boolean  @default(false) 

  tour    Tour     @relation(fields: [tourId], references: [id])
  booking Booking? @relation(fields: [bookingId], references: [id])
}

// model Package {
//   id           String   @id @default(uuid())
//   slug         String   @unique
//   durationDays Int

//   priceAdult    Int      // package total price
//   priceChild    Int      // package total price

//   maxCapacity  Int?     // optional global cap

//   isFeatured    Boolean  @default(false)
//   featuredOrder Int?
//   isActive      Boolean @default(false)

//   translations PackageTranslation[]
//   images        PackageImage[]
//   itinerary     PackageItinerary[]
//   FAQs          PackageFaq[]
//   tags          Tag[]

//   tours         PackageTour[]   // << composition

//   createdAt     DateTime @default(now())
//   updatedAt     DateTime @updatedAt
// }


// model PackageTour {
//   id        String @id @default(uuid())
//   packageId String
//   tourId    String

//   day       Int      // Day 1, Day 2, etc.
//   order     Int
//   isOptional Boolean @default(false)

//   package Package @relation(fields: [packageId], references: [id], onDelete: Cascade)
//   tour    Tour    @relation(fields: [tourId], references: [id])

//   @@unique([packageId, tourId])
//   createdAt DateTime @default(now())
//   updatedAt DateTime @updatedAt
// }

// model PackageTranslation {
//   id          String @id @default(uuid())
//   packageId   String
//   languageId  String

//   title       String?
//   overview    String? @db.Text
//   description String? @db.Text
//   highlights  String? @db.Text
//   included    String? @db.Text
//   excluded    String? @db.Text

//   package  Package  @relation(fields: [packageId], references: [id], onDelete: Cascade)
//   language Language @relation(fields: [languageId], references: [id])

//   @@unique([packageId, languageId])
// }

// model PackageImage {
//   id        String @id @default(uuid())
//   packageId String
//   url       String
//   isPrimary Boolean @default(false)
//   order     Int     @default(0)

//   translations PackageImageTranslation[]
//   package Package @relation(fields: [packageId], references: [id], onDelete: Cascade)

//   createdAt DateTime @default(now())
//   updatedAt DateTime @updatedAt
// }

// model PackageImageTranslation {
//   id         String @id @default(uuid())
//   imageId    String
//   languageId String
//   altText    String?

//   image    PackageImage @relation(fields: [imageId], references: [id], onDelete: Cascade)
//   language Language     @relation(fields: [languageId], references: [id])

//   @@unique([imageId, languageId])
// }

// model PackageItinerary {
//   id        String @id @default(uuid())
//   day       Int
//   packageId String

//   translations PackageItineraryTranslation[]

//   package Package @relation(fields: [packageId], references: [id], onDelete: Cascade)

//   createdAt DateTime @default(now())
//   updatedAt DateTime @updatedAt
// }
// model PackageItineraryTranslation {
//   id           String @id @default(uuid())
//   itineraryId  String
//   languageId   String

//   title        String?
//   content      String? @db.Text

//   itinerary PackageItinerary @relation(fields: [itineraryId], references: [id], onDelete: Cascade)
//   language   Language         @relation(fields: [languageId], references: [id])

//   @@unique([itineraryId, languageId])
// }

// model PackageBooking {
//   id         String @id @default(uuid())
//   packageId  String
//   guestId    String

//   bookingRef String @unique
//   startDate  DateTime

//   adults     Int
//   children   Int

//   subtotal   Int
//   tax        Int
//   serviceFee Int

//   totalPrice Int
//   currency   String @default("USD")

//   status     BookingStatus @default(PENDING)
//   createdAt  DateTime @default(now())

//   package Package   @relation(fields: [packageId], references: [id])
//   guest   GuestInfo @relation(fields: [guestId], references: [id])
// }
